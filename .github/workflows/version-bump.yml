name: Version Bump

on:
  workflow_dispatch:
    inputs:
      service:
        description: "Service to version bump"
        required: true
        type: choice
        options:
          - gateway
          - auth-service
          - campaign-service
          - donation-service
          - payment-service
          - totals-service
          - chat-service
          - admin-frontend
          - all
      bump_type:
        description: "Version bump type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

jobs:
  bump-version:
    name: Bump Service Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version for ${{ inputs.service }}
        run: |
          if [ "${{ inputs.service }}" == "all" ]; then
            echo "Bumping version for all services..."
            for service in gateway auth-service campaign-service donation-service payment-service totals-service chat-service; do
              if [ -f "apps/backend/$service/package.json" ]; then
                cd apps/backend/$service
                npm version ${{ inputs.bump_type }} --no-git-tag-version
                NEW_VERSION=$(node -p "require('./package.json').version")
                echo "✅ $service bumped to v$NEW_VERSION"
                cd ../../..
              fi
            done
            
            if [ -f "apps/frontend/admin-frontend/package.json" ]; then
              cd apps/frontend/admin-frontend
              npm version ${{ inputs.bump_type }} --no-git-tag-version
              NEW_VERSION=$(node -p "require('./package.json').version")
              echo "✅ admin-frontend bumped to v$NEW_VERSION"
              cd ../../..
            fi
          else
            SERVICE_DIR=""
            if [ -d "apps/backend/${{ inputs.service }}" ]; then
              SERVICE_DIR="apps/backend/${{ inputs.service }}"
            elif [ -d "apps/frontend/${{ inputs.service }}" ]; then
              SERVICE_DIR="apps/frontend/${{ inputs.service }}"
            fi
            
            if [ -n "$SERVICE_DIR" ] && [ -f "$SERVICE_DIR/package.json" ]; then
              cd $SERVICE_DIR
              npm version ${{ inputs.bump_type }} --no-git-tag-version
              NEW_VERSION=$(node -p "require('./package.json').version")
              echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
              echo "✅ ${{ inputs.service }} bumped to v$NEW_VERSION"
            else
              echo "❌ Service ${{ inputs.service }} not found"
              exit 1
            fi
          fi

      - name: Commit version bump
        run: |
          git add .
          if [ "${{ inputs.service }}" == "all" ]; then
            git commit -m "chore: bump version for all services (${{ inputs.bump_type }})"
          else
            git commit -m "chore(${{ inputs.service }}): bump version to v$NEW_VERSION"
          fi

      - name: Create Git tag
        if: inputs.service != 'all'
        run: |
          TAG="${{ inputs.service }}-v$NEW_VERSION"
          git tag -a "$TAG" -m "Release ${{ inputs.service }} v$NEW_VERSION"
          echo "Created tag: $TAG"

      - name: Push changes
        run: |
          git push origin main
          git push origin --tags

      - name: Create GitHub Release
        if: inputs.service != 'all'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ inputs.service }}-v${{ env.NEW_VERSION }}
          release_name: ${{ inputs.service }} v${{ env.NEW_VERSION }}
          body: |
            ## ${{ inputs.service }} v${{ env.NEW_VERSION }}

            Release type: ${{ inputs.bump_type }}

            ### Changes
            - Version bump to v${{ env.NEW_VERSION }}

            ### Docker Images
            - `ghcr.io/${{ github.repository_owner }}/care-for-all-${{ inputs.service }}:${{ env.NEW_VERSION }}`
            - `ghcr.io/${{ github.repository_owner }}/care-for-all-${{ inputs.service }}:latest`
          draft: false
          prerelease: false
