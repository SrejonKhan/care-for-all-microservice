name: CI - Continuous Integration

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  BUN_VERSION: "1.1.38"

jobs:
  # Job 1: Detect changed services
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set-matrix.outputs.services }}
      any_service_changed: ${{ steps.set-matrix.outputs.any_service_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gateway:
              - 'apps/backend/gateway/**'
              - 'packages/**'
            auth-service:
              - 'apps/backend/auth-service/**'
              - 'packages/**'
            campaign-service:
              - 'apps/backend/campaign-service/**'
              - 'packages/**'
            donation-service:
              - 'apps/backend/donation-service/**'
              - 'packages/**'
            payment-service:
              - 'apps/backend/payment-service/**'
              - 'packages/**'
            totals-service:
              - 'apps/backend/totals-service/**'
              - 'packages/**'
            chat-service:
              - 'apps/backend/chat-service/**'
              - 'packages/**'
            admin-frontend:
              - 'apps/frontend/admin-frontend/**'

      - name: Set matrix output
        id: set-matrix
        run: |
          # Build JSON array of changed services
          SERVICES="[]"

          if [ "${{ steps.filter.outputs.gateway }}" == "true" ]; then
            SERVICES=$(echo $SERVICES | jq '. + ["gateway"]')
          fi
          if [ "${{ steps.filter.outputs.auth-service }}" == "true" ]; then
            SERVICES=$(echo $SERVICES | jq '. + ["auth-service"]')
          fi
          if [ "${{ steps.filter.outputs.campaign-service }}" == "true" ]; then
            SERVICES=$(echo $SERVICES | jq '. + ["campaign-service"]')
          fi
          if [ "${{ steps.filter.outputs.donation-service }}" == "true" ]; then
            SERVICES=$(echo $SERVICES | jq '. + ["donation-service"]')
          fi
          if [ "${{ steps.filter.outputs.payment-service }}" == "true" ]; then
            SERVICES=$(echo $SERVICES | jq '. + ["payment-service"]')
          fi
          if [ "${{ steps.filter.outputs.totals-service }}" == "true" ]; then
            SERVICES=$(echo $SERVICES | jq '. + ["totals-service"]')
          fi
          if [ "${{ steps.filter.outputs.chat-service }}" == "true" ]; then
            SERVICES=$(echo $SERVICES | jq '. + ["chat-service"]')
          fi
          if [ "${{ steps.filter.outputs.admin-frontend }}" == "true" ]; then
            SERVICES=$(echo $SERVICES | jq '. + ["admin-frontend"]')
          fi

          echo "services=$SERVICES" >> $GITHUB_OUTPUT

          # Check if any service changed
          if [ "$SERVICES" != "[]" ]; then
            echo "any_service_changed=true" >> $GITHUB_OUTPUT
            echo "Changed services: $SERVICES"
          else
            echo "any_service_changed=false" >> $GITHUB_OUTPUT
            echo "No services changed"
          fi

  # Job 2: Lint and type check
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_service_changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check ${{ matrix.service }}
        continue-on-error: true
        run: |
          echo "Type checking ${{ matrix.service }}..."

          SERVICE_DIR=""
          if [ -d "apps/backend/${{ matrix.service }}" ]; then
            SERVICE_DIR="apps/backend/${{ matrix.service }}"
          elif [ -d "apps/frontend/${{ matrix.service }}" ]; then
            SERVICE_DIR="apps/frontend/${{ matrix.service }}"
          fi

          if [ -z "$SERVICE_DIR" ]; then
            echo "❌ Service directory not found"
            exit 1
          fi

          cd "$SERVICE_DIR"

          # Run TypeScript compiler in check mode
          if [ -f "tsconfig.json" ]; then
            echo "Running tsc --noEmit..."
            bunx tsc --noEmit || {
              echo "⚠️  Type check found issues but continuing..."
              exit 0
            }
          else
            echo "⚠️  No tsconfig.json found, skipping type check"
          fi

  # Job 3: Run tests for changed services
  test:
    name: Test Changed Services
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_service_changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests for ${{ matrix.service }}
        continue-on-error: true
        run: |
          echo "Testing ${{ matrix.service }}..."

          SERVICE_DIR=""
          if [ -d "apps/backend/${{ matrix.service }}" ]; then
            SERVICE_DIR="apps/backend/${{ matrix.service }}"
          elif [ -d "apps/frontend/${{ matrix.service }}" ]; then
            SERVICE_DIR="apps/frontend/${{ matrix.service }}"
          fi

          if [ -z "$SERVICE_DIR" ]; then
            echo "❌ Service directory not found"
            exit 1
          fi

          cd "$SERVICE_DIR"

          # Check if test script exists
          if grep -q '"test"' package.json; then
            echo "Running tests..."
            bun test || {
              echo "⚠️  No test files found or tests not configured, treating as success"
              exit 0
            }
          else
            echo "⚠️  No test script configured, skipping tests"
          fi

  # Job 4: Build changed services
  build:
    name: Build Changed Services
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: needs.detect-changes.outputs.any_service_changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Node (for frontend)
        if: matrix.service == 'admin-frontend'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build ${{ matrix.service }}
        run: |
          echo "Building ${{ matrix.service }}..."

          SERVICE_DIR=""
          if [ -d "apps/backend/${{ matrix.service }}" ]; then
            SERVICE_DIR="apps/backend/${{ matrix.service }}"
          elif [ -d "apps/frontend/${{ matrix.service }}" ]; then
            SERVICE_DIR="apps/frontend/${{ matrix.service }}"
          fi

          if [ -z "$SERVICE_DIR" ]; then
            echo "❌ Service directory not found"
            exit 1
          fi

          cd "$SERVICE_DIR"

          # Check if build script exists
          if grep -q '"build"' package.json; then
            echo "Running build..."
            if [ "${{ matrix.service }}" == "admin-frontend" ]; then
              npm run build
            else
              bun run build
            fi
          else
            echo "⚠️  No build script configured, skipping build"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ${{ matrix.service }}-build
          path: |
            apps/backend/${{ matrix.service }}/dist
            apps/frontend/${{ matrix.service }}/dist
            apps/frontend/${{ matrix.service }}/build
          if-no-files-found: warn
          retention-days: 7

  # Job 5: Build and push Docker images for changed services
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: |
      needs.detect-changes.outputs.any_service_changed == 'true' &&
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'))
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine service location and extract version
        id: service-info
        run: |
          SERVICE_DIR=""
          DOCKERFILE=""

          if [ -d "apps/backend/${{ matrix.service }}" ]; then
            SERVICE_DIR="apps/backend/${{ matrix.service }}"
            DOCKERFILE="apps/backend/${{ matrix.service }}/Dockerfile"
          elif [ -d "apps/frontend/${{ matrix.service }}" ]; then
            SERVICE_DIR="apps/frontend/${{ matrix.service }}"
            DOCKERFILE="apps/frontend/${{ matrix.service }}/Dockerfile"
          fi

          if [ -z "$SERVICE_DIR" ] || [ ! -f "$DOCKERFILE" ]; then
            echo "❌ Service ${{ matrix.service }} not found or has no Dockerfile, skipping Docker build"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "dockerfile=$DOCKERFILE" >> $GITHUB_OUTPUT

          # Extract version
          VERSION=$(cat $SERVICE_DIR/package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Service ${{ matrix.service }} version: $VERSION at $DOCKERFILE"

      - name: Build and push Docker image
        if: steps.service-info.outputs.skip != 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ steps.service-info.outputs.dockerfile }}
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/care-for-all-${{ matrix.service }}:latest
            ghcr.io/${{ github.repository_owner }}/care-for-all-${{ matrix.service }}:${{ steps.service-info.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/care-for-all-${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.service-info.outputs.version }}

  # Job 6: CI Status Summary
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-and-typecheck, test, build, docker-build]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Services Changed**: ${{ needs.detect-changes.outputs.any_service_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.any_service_changed }}" == "true" ]; then
            echo "### Changed Services:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.detect-changes.outputs.services }}' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No services changed in this push." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status:" >> $GITHUB_STEP_SUMMARY
          echo "- Lint & Type Check: ${{ needs.lint-and-typecheck.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Show what was optimized
          if [ "${{ needs.detect-changes.outputs.any_service_changed }}" == "true" ]; then
            echo "✅ **Optimization**: Only changed services were tested and built" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if any required job failed
        if: |
          (needs.lint-and-typecheck.result == 'failure') ||
          (needs.test.result == 'failure') ||
          (needs.build.result == 'failure')
        run: |
          echo "❌ CI pipeline failed. Check the logs above."
          exit 1
