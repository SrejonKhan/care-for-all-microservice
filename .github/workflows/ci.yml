name: CI - Continuous Integration

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  BUN_VERSION: "1.1.38"

jobs:
  # Job 1: Detect changed services
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.changes }}
      any_service_changed: ${{ steps.filter.outputs.any_changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed services
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gateway:
              - 'apps/backend/gateway/**'
              - 'packages/**'
            auth-service:
              - 'apps/backend/auth-service/**'
              - 'packages/**'
            campaign-service:
              - 'apps/backend/campaign-service/**'
              - 'packages/**'
            donation-service:
              - 'apps/backend/donation-service/**'
              - 'packages/**'
            payment-service:
              - 'apps/backend/payment-service/**'
              - 'packages/**'
            totals-service:
              - 'apps/backend/totals-service/**'
              - 'packages/**'
            chat-service:
              - 'apps/backend/chat-service/**'
              - 'packages/**'
            admin-frontend:
              - 'apps/frontend/admin-frontend/**'

  # Job 2: Lint and type check
  lint-and-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_service_changed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Determine base commit
        id: base
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "base_sha=origin/${{ github.base_ref }}" >> $GITHUB_OUTPUT
          else
            echo "base_sha=${{ github.event.before }}" >> $GITHUB_OUTPUT
          fi

      - name: Type check changed services
        run: |
          echo "Running type check for changed services..."
          bunx turbo run build --filter=...[${BASE_SHA}] --dry-run=json
        env:
          BASE_SHA: ${{ steps.base.outputs.base_sha }}

  # Job 3: Run tests for changed services
  test:
    name: Test Changed Services
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.any_service_changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests for ${{ matrix.service }}
        run: |
          echo "Testing ${{ matrix.service }}..."
          if [ -d "apps/backend/${{ matrix.service }}" ]; then
            cd apps/backend/${{ matrix.service }}
          elif [ -d "apps/frontend/${{ matrix.service }}" ]; then
            cd apps/frontend/${{ matrix.service }}
          fi
          bun test || echo "No tests found, skipping..."

  # Job 4: Build changed services
  build:
    name: Build Changed Services
    runs-on: ubuntu-latest
    needs: [detect-changes, test]
    if: needs.detect-changes.outputs.any_service_changed == 'true'
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build ${{ matrix.service }}
        run: |
          echo "Building ${{ matrix.service }}..."
          if [ -d "apps/backend/${{ matrix.service }}" ]; then
            cd apps/backend/${{ matrix.service }}
            bun run build
          elif [ -d "apps/frontend/${{ matrix.service }}" ]; then
            cd apps/frontend/${{ matrix.service }}
            bun run build || npm run build
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-build
          path: |
            apps/*/$${{ matrix.service }}/dist
            apps/*/$${{ matrix.service }}/build
          retention-days: 7

  # Job 5: Build and push Docker images for changed services
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [detect-changes, build]
    if: |
      needs.detect-changes.outputs.any_service_changed == 'true' &&
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'))
    strategy:
      fail-fast: false
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from package.json
        id: version
        run: |
          if [ -d "apps/backend/${{ matrix.service }}" ]; then
            VERSION=$(cat apps/backend/${{ matrix.service }}/package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')
          elif [ -d "apps/frontend/${{ matrix.service }}" ]; then
            VERSION=$(cat apps/frontend/${{ matrix.service }}/package.json | grep '"version"' | head -1 | awk -F: '{ print $2 }' | sed 's/[",]//g' | tr -d '[[:space:]]')
          else
            VERSION="1.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Service ${{ matrix.service }} version: $VERSION"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: |
            ${{ 
              (contains(fromJSON('["gateway","auth-service","campaign-service","donation-service","payment-service","totals-service","chat-service"]'), matrix.service) && 
              format('apps/backend/{0}/Dockerfile', matrix.service)) ||
              format('apps/frontend/{0}/Dockerfile', matrix.service)
            }}
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/care-for-all-${{ matrix.service }}:latest
            ghcr.io/${{ github.repository_owner }}/care-for-all-${{ matrix.service }}:${{ steps.version.outputs.version }}
            ghcr.io/${{ github.repository_owner }}/care-for-all-${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.version.outputs.version }}

  # Job 6: CI Status Summary
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-and-typecheck, test, build, docker-build]
    if: always()
    steps:
      - name: Check CI Status
        run: |
          echo "## CI Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Event**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Services Changed**: ${{ needs.detect-changes.outputs.any_service_changed }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changes.outputs.any_service_changed }}" == "true" ]; then
            echo "### Changed Services:" >> $GITHUB_STEP_SUMMARY
            echo "${{ needs.detect-changes.outputs.services }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Job Status:" >> $GITHUB_STEP_SUMMARY
          echo "- Lint & Type Check: ${{ needs.lint-and-typecheck.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: |
          needs.lint-and-typecheck.result == 'failure' ||
          needs.test.result == 'failure' ||
          needs.build.result == 'failure' ||
          needs.docker-build.result == 'failure'
        run: |
          echo "‚ùå CI pipeline failed. Check the logs above."
          exit 1
