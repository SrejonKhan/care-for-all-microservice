input {
  beats {
    port => 5044
    host => "0.0.0.0"
  }
}

filter {
  # Parse JSON logs from containers
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
      skip_on_invalid_json => true
    }
  }

  # Add Docker metadata
  if [container] {
    mutate {
      add_field => {
        "container_name" => "%{[container][name]}"
        "container_id" => "%{[container][id]}"
      }
    }
  }

  # Extract service name from container name or log
  if [serviceName] {
    mutate {
      add_field => { "service" => "%{serviceName}" }
    }
  } else if [container_name] {
    mutate {
      add_field => { "service" => "%{container_name}" }
    }
  }

  # Parse timestamp if present
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }

  # Add log level field
  if [level] {
    mutate {
      uppercase => ["level"]
      add_field => { "log_level" => "%{level}" }
    }
  }

  # Add trace context if present
  if [traceId] {
    mutate {
      add_field => { "trace_id" => "%{traceId}" }
    }
  }
  if [spanId] {
    mutate {
      add_field => { "span_id" => "%{spanId}" }
    }
  }
}

output {
  # Send to Elasticsearch with date-based index
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-%{+YYYY.MM.dd}"
    
    # Add service-specific index if service name is present
    # index => "logs-%{service}-%{+YYYY.MM.dd}"
  }

  # Debug output (optional, comment out in production)
  # stdout {
  #   codec => rubydebug
  # }
}

